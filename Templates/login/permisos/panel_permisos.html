{% load static %}
{% load permisos_tags %}

{% include 'Nucleo/arriba.html' %}
{% include 'Nucleo/centro.html' %}

{% block extra_css %}
<style>
  .permission-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
  }
  
  .permission-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .permission-card.has-permissions {
    border-left-color: #28a745;
  }
  
  .permission-card.no-permissions {
    border-left-color: #dc3545;
  }
  
  .badge-permission {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1 class="m-0">
          <i class="fas fa-user-shield mr-2"></i>
          Control de Permisos
        </h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <!-- TODO: Crear vista y URL para 'panel' -->
          <li class="breadcrumb-item"><a href="#">Panel</a></li>
          <li class="breadcrumb-item active">Permisos</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<section class="content">
  <div class="container-fluid">
    <!-- Estadísticas -->
    <div class="row">
      <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ total_usuarios }}</h3>
            <p>Total Usuarios</p>
          </div>
          <div class="icon">
            <i class="fas fa-users"></i>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ usuarios_con_permisos }}</h3>
            <p>Con Permisos</p>
          </div>
          <div class="icon">
            <i class="fas fa-user-check"></i>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ total_roles }}</h3>
            <p>Roles Activos</p>
          </div>
          <div class="icon">
            <i class="fas fa-user-tag"></i>
          </div>
        </div>
      </div>
      
      <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
          <div class="inner">
            <h3>{{ total_acciones }}</h3>
            <p>Acciones Disponibles</p>
          </div>
          <div class="icon">
            <i class="fas fa-tasks"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card card-outline card-primary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-bolt mr-2"></i>
              Acciones Rápidas
            </h3>
          </div>
          <div class="card-body">
            {% if user|tiene_permiso:'gestionar_roles' %}
            <!-- TODO: Crear vista y URL para 'gestionar_roles' -->
            <a href="#" class="btn btn-primary mr-2">
              <i class="fas fa-user-tag mr-1"></i>
              Gestionar Roles
            </a>
            {% endif %}
            {% if user|tiene_permiso:'gestionar_acciones' %}
            <!-- TODO: Crear vista y URL para 'gestionar_acciones' -->
            <a href="#" class="btn btn-success mr-2">
              <i class="fas fa-tasks mr-1"></i>
              Gestionar Acciones
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de usuarios -->
    <div class="row">
      <div class="col-12">
        <div class="card card-outline card-primary">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-users mr-2"></i>
              Usuarios del Sistema
            </h3>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 200px;">
                <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar usuario...">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-default">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body table-responsive p-0">
            <table class="table table-hover text-nowrap">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Usuario</th>
                  <th>Nombre Completo</th>
                  <th>Email</th>
                  <th>Rol Asignado</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for usuario in page_obj %}
                  {% with permiso=usuario.permisos_usuario.all|first %}
                  <tr>
                    <td>{{ usuario.id }}</td>
                    <td>{{ usuario.user.username }}</td>
                    <td>{{ usuario.get_nombre_completo }}</td>
                    <td>{{ usuario.get_email }}</td>
                    <td>
                      {% if permiso and permiso.rol %}
                        <span class="badge badge-info">{{ permiso.rol.nombre }}</span>
                      {% else %}
                        <span class="badge badge-secondary">Sin rol</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if usuario.activo %}
                        <span class="badge badge-success">Activo</span>
                      {% else %}
                        <span class="badge badge-danger">Inactivo</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if user|tiene_permiso:'gestionar_permisos_usuario' %}
                      <!-- TODO: Crear vista y URL para 'gestionar_permisos_usuario' -->
                      <a href="#" class="btn btn-sm btn-primary">
                        <i class="fas fa-edit mr-1"></i>
                        Gestionar Permisos
                      </a>
                      {% endif %}
                    </td>
                  </tr>
                  {% endwith %}
                {% empty %}
                  <tr>
                    <td colspan="7" class="text-center">
                      <p class="text-muted">No hay usuarios registrados.</p>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="card-footer clearfix">
            {% if page_obj.has_other_pages %}
              <ul class="pagination pagination-sm m-0 float-right">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">«</a>
                  </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">»</a>
                  </li>
                {% endif %}
              </ul>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Búsqueda en tabla
    $('input[name="table_search"]').on('keyup', function() {
      var value = $(this).val().toLowerCase();
      $('table tbody tr').filter(function() {
        $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
      });
    });
  });
</script>
{% endblock %}

{% include 'Nucleo/abajo.html' %}

