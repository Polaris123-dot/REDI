{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{% static 'img/LogoMr.ico' %}" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Documental - DocuArchive</title>
    <link rel="stylesheet" href="{% static 'Personalizados/Paginaciones/styles.css' %}">

</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>DocuArchive</h1>
                </div>
                <nav class="nav">
                    <a href="{% url 'catalogo_publico:index' %}" class="nav-link active">Inicio</a>
                    <a href="{% url 'catalogo_publico:buscar' %}" class="nav-link">B√∫squeda</a>
                    <!--<a href="detail.html" class="nav-link active">Proyectos</a>-->
                    <a href="#" class="nav-link">Acerca de</a>
                </nav>
                <div class="header-actions">
                    <a href="{% url 'usuarios:login' %}" class="header-login">Iniciar sesi√≥n</a>
                    <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
                        <span class="theme-icon">‚òÄÔ∏è</span>
                    </button>
                </div>
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Added hero banner section -->
    <section class="detail-hero">
        <div class="detail-hero-overlay">
            <div class="container">
                <div class="detail-hero-content">
                    <span class="detail-hero-category">
                        {% if categorias %}
                            {% for categoria in categorias %}{{ categoria.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% else %}
                            Sin categor√≠a
                        {% endif %}
                    </span>
                    <h1 class="detail-hero-title">{{ titulo }}</h1>
                </div>
            </div>
        </div>
    </section>

    <main class="detail-page">
        <!-- Added two-column layout wrapper -->
        <div class="detail-wrapper">
            <div class="container">
                <!-- Restructured into two-column layout -->
                <div class="detail-layout">
                    <!-- Main content column (80%) -->
                    <article class="detail-main">
                        <div class="detail-content">
                            <div class="detail-meta">
                                {% if autores %}
                                <span class="meta-item"><strong>Autor√≠a:</strong> {{ autores|join:", " }}</span>
                                {% else %}
                                <span class="meta-item"><strong>Autor√≠a:</strong> Informaci√≥n no disponible</span>
                                {% endif %}
                                {% if editor %}
                                <span class="meta-item"><strong>Editor:</strong> {{ editor }}</span>
                                {% endif %}
                                {% if fecha_publicacion %}
                                <span class="meta-item"><strong>Publicado:</strong> {{ fecha_publicacion|date:"d \\d\\e F, Y" }}</span>
                                {% endif %}
                                {% if tipo_publicacion %}
                                <span class="meta-item"><strong>Tipo:</strong> {{ tipo_publicacion }}</span>
                                {% endif %}
                                {% if categorias %}
                                <span class="meta-item"><strong>Categor√≠as:</strong> {% for categoria in categorias %}{{ categoria.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                                {% endif %}
                            </div>

                            <div class="detail-body">
                                <h2>Resumen</h2>
                                <p>{{ resumen }}</p>


                            </div>
                        </div>

                        <!-- Comments section now within main column -->
                        {% if documento_id %}
                        <section class="comments-section">
                            <h2 class="comments-title">Comentarios</h2>
                            
                            <form class="comment-form" id="commentForm">
                                {% csrf_token %}
                                <input type="hidden" id="documentoId" value="{{ documento_id }}">
                                <textarea 
                                    class="comment-textarea" 
                                    placeholder="Escriba su comentario aqu√≠..." 
                                    rows="4"
                                    id="commentText"
                                    required
                                ></textarea>
                                <div class="comment-form-footer">
                                    {% if user.is_authenticated %}
                                    <span class="comment-author-display">Comentando como: {{ user.get_full_name|default:user.username }}</span>
                                    {% else %}
                                    <input 
                                        type="text" 
                                        class="comment-author-input" 
                                        placeholder="Su nombre"
                                        id="commentAuthor"
                                        required
                                    >
                                    {% endif %}
                                    <button type="submit" class="comment-submit">Publicar Comentario</button>
                                </div>
                            </form>

                            <div class="comments-list" id="commentsList">
                                {% if comentarios %}
                                    {% for comentario in comentarios %}
                                    <article class="comment">
                                        <div class="comment-header">
                                            <span class="comment-author">{{ comentario.usuario_nombre }}</span>
                                            <span class="comment-date">{{ comentario.fecha_creacion_str|default:comentario.fecha_creacion|date:"d \\d\\e F, Y" }}</span>
                                        </div>
                                        <p class="comment-text">{{ comentario.contenido }}</p>
                                    </article>
                                    {% endfor %}
                                {% else %}
                                    <p class="no-comments">No hay comentarios a√∫n. ¬°S√© el primero en comentar!</p>
                                {% endif %}
                            </div>
                        </section>
                        {% endif %}
                    </article>

                    <!-- Added sidebar column (20%) -->
                    <aside class="detail-sidebar">
                        <!-- Table of Contents -->
                        <div class="sidebar-section">
                            <h3 class="sidebar-title">Etiquetas Asociadas</h3>
                            <nav class="toc-nav">
                                {% if etiquetas %}
                                    {% for etiqueta in etiquetas %}
                                    <a href="{% url 'catalogo_publico:buscar' %}?q={{ etiqueta.nombre|urlencode }}" class="toc-link">#{{ etiqueta.nombre }}</a>
                                    {% endfor %}
                                {% else %}
                                <p class="text-muted">No hay etiquetas asociadas.</p>
                                {% endif %}
                            </nav>
                        </div>


                        <!-- Author Info -->
                        <div class="sidebar-section">
                            <h3 class="sidebar-title">Autores</h3>
                            {% if autores_detalle %}
                            <div class="author-list">
                                {% for autor in autores_detalle %}
                                <div class="author-entry">
                                    <p class="author-name">
                                        {% if autor.usuario_id %}
                                        <a href="{% url 'catalogo_publico:autor_perfil' user_id=autor.usuario_id %}">{{ autor.nombre }}</a>
                                        {% else %}
                                        {{ autor.nombre }}
                                        {% endif %}
                                    </p>
                                    {% if autor.afiliacion %}
                                    <p class="author-meta">{{ autor.afiliacion }}</p>
                                    {% endif %}
                                    {% if autor.orcid %}
                                    <p class="author-meta"><strong>ORCID:</strong> {{ autor.orcid }}</p>
                                    {% endif %}
                                    {% if autor.email %}
                                    <p class="author-meta"><strong>Contacto:</strong> {{ autor.email }}</p>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-muted">No se registran autores para esta publicaci√≥n.</p>
                            {% endif %}
                        </div>

                        <div class="sidebar-section">
                            <h3 class="sidebar-title">Editor Responsable</h3>
                            <div class="author-info">
                                <p class="author-name">
                                    {% if editor_id %}
                                    <a href="{% url 'catalogo_publico:autor_perfil' user_id=editor_id %}">{{ editor|default:"Sin editor" }}</a>
                                    {% else %}
                                    {{ editor|default:"Sin editor" }}
                                    {% endif %}
                                </p>
                                {% if url_externa %}
                                <p class="author-meta"><a href="{{ url_externa }}" target="_blank" rel="noopener noreferrer">Ver publicaci√≥n externa</a></p>
                                {% endif %}
                            </div>
                            {% if doi or issn or isbn %}
                            <div class="publication-meta">
                                {% if doi %}
                                <p><strong>DOI:</strong> {{ doi }}</p>
                                {% endif %}
                                {% if issn %}
                                <p><strong>ISSN:</strong> {{ issn }}</p>
                                {% endif %}
                                {% if isbn %}
                                <p><strong>ISBN:</strong> {{ isbn }}</p>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Related Projects -->
                        <div class="sidebar-section">
                            <h3 class="sidebar-title">Archivos</h3>
                            <div class="related-projects">
                            {% if archivo_url and documento_id %}
                                <a href="{% url 'catalogo_publico:descargar_documento' documento_id %}" class="related-project" target="_blank" rel="noopener noreferrer">
                                    <span class="related-icon">üìÑ</span>
                                    <span class="related-title">Descargar Archivo</span>
                                </a>
                            {% elif url_externa %}
                                <a href="{{ url_externa }}" class="related-project" target="_blank" rel="noopener noreferrer">
                                    <span class="related-icon">üîó</span>
                                    <span class="related-title">Ver publicaci√≥n externa</span>
                                </a>
                            {% else %}
                                <p class="text-muted">Archivo no disponible</p>
                            {% endif %}
                            </div>
                                
                            <h3 class="sidebar-title" style="margin-top: 2rem;">Publicaciones Relacionadas</h3>

                            {% if proyectos_relacionados %}
                                {% for r in proyectos_relacionados %}
                                    <div class="related-projects">
                                        <a href="{{ r.url }}" class="related-project">
                                            <span class="related-icon">üìä</span>
                                            <span class="related-title">{{ r.titulo }}</span>
                                        </a>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No se encontraron publicaciones relacionadas.</p>
                            {% endif %}

                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 DocuArchive. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="{% static 'Personalizados/Paginaciones/script.js' %}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Obtiene la ruta actual (por ejemplo: /Principal/index/)
        const currentPath = window.location.pathname;

        console.log("Current Path:", currentPath);
        // Selecciona todos los enlaces del men√∫
        const navLinks = document.querySelectorAll(".nav-link");

        navLinks.forEach(link => {
            // Quita cualquier clase 'active'
            link.classList.remove("active");

            // Si la ruta del enlace coincide parcialmente con la actual, la marca como activa
            if (currentPath.includes(link.getAttribute("href").replace(/\/$/, ""))) {
                link.classList.add("active");
            }
        });
        
        // Manejo de comentarios
        const commentForm = document.getElementById('commentForm');
        if (commentForm) {
            commentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const documentoId = document.getElementById('documentoId').value;
                const contenido = document.getElementById('commentText').value.trim();
                const nombreAutor = document.getElementById('commentAuthor') ? document.getElementById('commentAuthor').value.trim() : '';
                
                if (!contenido) {
                    alert('Por favor, escriba un comentario');
                    return;
                }
                
                // Obtener token CSRF
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                const data = {
                    documento_id: parseInt(documentoId),
                    contenido: contenido
                };
                
                if (nombreAutor) {
                    data.nombre_autor = nombreAutor;
                }
                
                fetch('{% url "catalogo_publico:comentario_publico_create" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Agregar el comentario a la lista
                        const commentsList = document.getElementById('commentsList');
                        const noCommentsMsg = commentsList.querySelector('.no-comments');
                        if (noCommentsMsg) {
                            noCommentsMsg.remove();
                        }
                        
                        const commentArticle = document.createElement('article');
                        commentArticle.className = 'comment';
                        commentArticle.innerHTML = `
                            <div class="comment-header">
                                <span class="comment-author">${escapeHtml(data.data.usuario_nombre)}</span>
                                <span class="comment-date">${data.data.fecha_creacion_str || 'Ahora'}</span>
                            </div>
                            <p class="comment-text">${escapeHtml(data.data.contenido)}</p>
                        `;
                        commentsList.insertBefore(commentArticle, commentsList.firstChild);
                        
                        // Limpiar el formulario
                        document.getElementById('commentText').value = '';
                        if (document.getElementById('commentAuthor')) {
                            document.getElementById('commentAuthor').value = '';
                        }
                    } else {
                        alert('Error al publicar comentario: ' + (data.error || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al publicar comentario. Por favor, intente nuevamente.');
                });
            });
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
    });
    </script>

</body>
</html>
